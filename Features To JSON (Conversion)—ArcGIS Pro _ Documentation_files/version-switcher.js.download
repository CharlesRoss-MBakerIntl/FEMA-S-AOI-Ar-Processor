if(!docConfig){
  docConfig = {};
}
console.log("Hello there. I am version switcher")
if(!docConfig.switcher){
docConfig.switcher = {
  "basepaths": {
    "3.3": "pro-app/latest",
    "3.2": "pro-app/3.2",
  },

  "switchercases": {
    "3.3": "3.3",
    "3.2": "3.2",
  },

  "caseTbl": {
    "__order": {
      "3.4" : 1,
      "3.3" : 2,
    },

    //10.3 section
    /*"database-servers-tutorial": ['x','-'],
    "exercise-1-database-server-tutorial": ['x','-'],
    "exercise-2-database-servers-tutorial": ['x','-'],
    "exercise-3-database-servers-tutorial": ['x','-'],
    */
},

  "switcherdisplay": true,
};
}

var currentURL = document.location.href;
//var customVersion = null;
/*if(currentURL.match(/(\/pro-app\/latest\/test\/)/)){
docConfig.switcher.basepaths["2.7"] = "pro-app/latest/test";
docConfig.switcher.basepaths["2.6"] = "pro-app/2.6/test";
}*/


var english = false;
if(currentURL.match(/(\/en\/)/)) {
  english = true;
}
//Remove 10.8 switcher option for non-English server pages

// if(!english){
//   var delSwitchers = ["3.3"];
//   for(i in delSwitchers){
//       if(delSwitchers[i] in docConfig.switcher.switchercases){
//           delete docConfig.switcher.switchercases[delSwitchers[i]];
//       }
//   }
//   for(i in docConfig.switcher.basepaths){
//       docConfig.switcher.basepaths[i] = docConfig.switcher.basepaths[i].replace("3.2","latest");
//   }
// }


$.whenAll = function(firstParam) {
var args = arguments,
  sliceDeferred = [].slice,
  i = 0,
  length = args.length,
  count = length,
  rejected,
  deferred = length <= 1 && firstParam && jQuery.isFunction(firstParam.promise) ?
  firstParam :
  jQuery.Deferred();

function resolveFunc(i, reject) {
  return function(value) {
    rejected |= reject;
    args[i] = arguments.length > 1 ? sliceDeferred.call(arguments, 0) : value;
    if (!(--count)) {
      // Strange bug in FF4:
      // Values changed onto the arguments object sometimes end up as undefined values
      // outside the $.when method. Cloning the object into a fresh array solves the issue
      var fn = rejected ? deferred.rejectWith : deferred.resolveWith;
      fn.call(deferred, deferred, sliceDeferred.call(args, 0));
    }
  };
}

if (length > 1) {
  for (; i < length; i++) {
    if (args[i] && jQuery.isFunction(args[i].promise)) {
      args[i].promise().then(resolveFunc(i), resolveFunc(i, true));
    } else {
      --count;
    }
  }
  if (!count) {
    deferred.resolveWith(deferred, args);
  }
} else if (deferred !== firstParam) {
  deferred.resolveWith(deferred, length ? [firstParam] : []);
}
return deferred.promise();
};

jQuery(document).ready(function($){
/*if(!docConfig || !docConfig.switcher){
  return false;
}*/

// Temporary condition. Once l10n content is ready for 10.4 we can remove this condition
/* if(docConfig['localedir'] && docConfig['localedir'] != "en"){
  return;
}*/
//exclude version switcher for following pattern.
if(currentURL.match(/(\/sdk\/api-reference\/)/)){
  return;
}

if(!doc){
  var doc = {};
}

function dbg (o) {
  if (true)  console.info (o);
}

  doc.switcher = (function () {

  var switcherCfg = window.docConfig.switcher,
  pathname = window.location.pathname,
  pathparts = pathname.split ("/"),
  fname = pathparts[pathparts.length-1],
  //plat = $.cookie (switcherCfg.appproduct) || switcherCfg.defaultplatformvalue,
  plat =  pathparts[pathparts.length-2],
  isHome = pathparts.length <= 4, //???
  version = (pathname.match(/(\/2\.6\/)/)) ? "2.6" : (pathname.match(/(\/2\.7\/)/)) ? "2.7" : (pathname.match(/(\/2\.8\/)/)) ? "2.8" : (pathname.match(/(\/2\.9\/)/)) ? "2.9" : (pathname.match(/(\/3\.0\/)/)) ? "3.0" : (pathname.match(/(\/3\.1\/)/)) ? "3.1" : (pathname.match(/(\/3\.2\/)/)) ? "3.2" : "3.3",
  switcherLinkClass = "current";
  // if(!english){
  //   version = (pathname.match(/(\/2\.6\/)/)) ? "2.6" : (pathname.match(/(\/2\.7\/)/)) ? "2.7" : (pathname.match(/(\/2\.8\/)/)) ? "2.8" : (pathname.match(/(\/2\.9\/)/)) ? "2.9" : (pathname.match(/(\/3\.0\/)/)) ? "3.0" : (pathname.match(/(\/3\.1\/)/)) ? "3.1" : "3.2"
  // }
  
  var archiveUrl = "/{0}/pro-app/latest/get-started/archived-arcgis-pro-help.htm".format(docConfig['localedir'].toLowerCase());;
  if(pathname.match(/(\/2.6\/|\/2.7\/|\/2.8\/|\/2.9\/|\/3.0\/|\/3.1\/)/)){
    var versionRetireMsg = "<div class='alert alert-yellow is-active trailer-1 archive-note'>{0}</div>"
    window.docConfig.switcher.switcherdisplay = false;
    $("main .feedback").remove();
  }

  return {

    addSwitcherLinks : function(switcherLocation) {
      if(!(isHome) && (switcherCfg.switcherdisplay)){

        version = (window.customVersion !== undefined) ? customVersion : version;
        var platK = version+"~"+plat;
        var versionLabel = (window.customVersionLabel !== undefined) ? customVersionLabel : 'ArcGIS Pro';
           
        var links = '<div class="trailer-1" id="platforms">' + '<span class="product" style="color:#757575;">' + versionLabel +' '+ version + '</span>';
        links += '<span class="divider"> | </span><span class="dropdown js-dropdown dropdown-btn js-dropdown-toggle"><button class="btn btn-transparent" href="#" tabindex="0" aria-haspopup="true" aria-expanded="false"> ' + this.t('other-versions');
        links += '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 -10 32 40" class="svg-icon padding-left-half"><path d="M28 9v5L16 26 4 14V9l12 12L28 9z"/></svg></button>';
        linkData = this.generateSwitcherLinks();
        links += linkData[0];
        links += '</span>';
        links += '<span class="divider">|</span><span><a href="' + archiveUrl + '" target="_blank"> ' + this.t('help-archive');
        links += '</a></span></div>';
    

        ajaxRequests = [];
        linksNum = linkData[1].length;
        for (i = 0; i <= 14; i++) {
          if (i >= linksNum || linkData[1][i][1] == '#') {
            ajaxRequests.push(null);
          } else {
      ajaxRequests.push($.ajax(linkData[1][i][1]));
          }
        }
        $.whenAll(ajaxRequests[0], ajaxRequests[1], ajaxRequests[2], ajaxRequests[3], ajaxRequests[4], ajaxRequests[5], ajaxRequests[6], ajaxRequests[7], ajaxRequests[8], ajaxRequests[9], ajaxRequests[10], ajaxRequests[11], ajaxRequests[12], ajaxRequests[13], ajaxRequests[14], $(switcherLocation).after(links)).always(function(a0, a1, a2, a3, a4, a5, a6, a7, a8, a9, a10, a11, a12, a13, a14, a15) {
          responses = [a0, a1, a2, a3, a4, a5, a6, a7, a8, a9, a10, a11, a12, a13, a14];
          for (i = 0; i < linksNum; i++) {
            if (responses[i] != null) {
              if (responses[i][1] == 'error') {
                removeClass = 'available';
                addClass = 'disabled';
                href = 'javascript:void(0)';

              } else {
                removeClass = 'disabled';
                addClass = 'available';
                href = linkData[1][i][1];
              }
              linkElement = $('#' + linkData[1][i][0]);
              linkElement.attr('href', href);
              if (linkElement.hasClass(removeClass)) {
                linkElement.removeClass(removeClass);
              }
              linkElement.addClass(addClass);
            }
          }
          $('#platforms').addClass('processed');
        });
            //$(switcherLocation).after (links);

      } else {
        if(versionRetireMsg){
			var latestURL = pathname.replace(version,"latest");
			$(switcherLocation).after(versionRetireMsg.format(this.t("version-retire-msg").format(version,latestURL,archiveUrl)));
			var baseLatestURL = latestURL.substring(0, latestURL.lastIndexOf("/"))
			var fallbackTopic = "/{0}/pro-app/latest/get-started/get-started.htm".format(docConfig['localedir'].toLowerCase());
			$.get( latestURL)
			  .always(function(data, statusText, xhr) {
				if(!xhr || xhr.status != 200){
					$.get( baseLatestURL)
					.always(function(data, statusText, xhr) {
						latestURL = (xhr.status == 200)?baseLatestURL+"/":fallbackTopic
						$(".archive-note").find('a:eq(1)').attr('href', latestURL);
					})
				}
			})
		  }
		return true;
      }
        },

        generateSwitcherLinks : function() {

      var switcherLinks = "",
        dropDownFlag = false;
        keyL = []
      $.each (switcherCfg.switchercases, function (k, v) {
        keyL.push (k);
      });

      switcherLinks = '<nav class="dropdown-menu">';
      var versionArray = [];
      keyL.sort().reverse();
      //$.each(switcherCfg.keyorder || keyL, function (idx, val) {
        $.each(keyL, function (idx, val) {

        var k = val,
          v = switcherCfg.switchercases[k]
        // dbg ("generateSwitcherLinks: " + k + " : " + v)

        var url = doc.switcher.getTargetURL(k),
          kArr = k.split(":"),
          switcherLinkStatus = (kArr.length >=2) ? kArr[1] : ""



        k = kArr[0]
        linkId = k.replace(/[^a-z0-9\s]/gi, '');
        if(k.indexOf("~") >= 0){

           var keyArr = k.split("~");

           if(!keyArr[1]) {
             /*if(dropDownFlag) {
              switcherLinks += '</ul><hr>';
              dropDownFlag = false;
            }*/
             // for example key is "desktop."
             switcherLinks += '<span class="dropdown-title">' + v + '</span>';
             //dropDownFlag = true;
           } else {
             versionArray.push([linkId, url]);
       switcherLinks += '<a id="' + linkId + '" data-plat="' + keyArr[1] + '" class="dropdown-link ' + switcherLinkClass + '" href="' + url + '">' + v + '</a>';
           }
        } else {
          versionArray.push([linkId, url]);
    switcherLinks += '<a id="' + linkId + '" data-plat="' + k + '" class="dropdown-link ' + switcherLinkClass + '" href="' + url + '">' + v + '</a>';
        }
      });
      switcherLinks += '</nav>'

      //return switcherLinks;
      return [switcherLinks, versionArray];
        },

    getTargetURL : function (key){
      var kArr = key.split("~"),
      newVersion = kArr[0],
      k = (kArr.length > 1)?kArr[1]:key;
      var versionPath = switcherCfg.basepaths[newVersion],
        prefixBase = (versionPath) ? '/' + doc.switcher.getCurrentLang() + '/' + versionPath : "",
        pathpfx = window.location.pathname.split ("/").slice (0, -1).join ("/"),
        url, fileName;


       //dbg ("getTargetURL: " + k + "=>" + pathpfx + " ?==" + prefixBase + " % " + fname);

      if (pathpfx.indexOf (prefixBase) >=0) {
          switcherLinkClass = "is-active";
          url = pathpfx + "/" + fname;
          //url = window.location.pathname;

      } else {
        var fnameVal = this.specialCasesLookup(k, fname);

         //dbg ("getTargetURL.specialCasesLookup: " + k + " => " + fnameVal);
        if(fnameVal == "x" || (typeof switcherCfg.disable !== 'undefined' && switcherCfg.disable.indexOf(newVersion) != -1)){
          // disable click
          url = "#";
          switcherLinkClass = "disabled";


        } else {

          //tmp hack to create relative url
          //works: /en/web-adaptor/beta/install/java-linux/welcome-arcgis-web-adaptor-install-guide.htm
          //NOT: /en/collector/windows/collect-data/collect-tutorial.htm
          //url = "../" + key + "/" + fnameVal;
          url = pathpfx.replace(switcherCfg.basepaths[version], switcherCfg.basepaths[newVersion]);
          url +=  "/" + fnameVal;

          switcherLinkClass = "available";
        }
      }
      return url
    },

    //getTargetURL
    specialCasesLookup : function (key,fileName){
      var keyPosition = (switcherCfg.caseTbl && key in switcherCfg.caseTbl['__order']) ? switcherCfg.caseTbl['__order'][key] -1 : -1,
        fnameParts = fileName.split ("."),
        fnameKey = (fnameParts.length == 2)? fnameParts[0] : "",
        fnameVal = "x";

      //dbg ("specialCasesLookup: " +keyPosition + " " + fnameKey);


      if(keyPosition >= 0)  {
        if (fnameKey in switcherCfg.caseTbl) {
          fnameVal = switcherCfg.caseTbl[fnameKey][keyPosition];
          fnameVal =  (fnameVal == "x") ? "x" : ((fnameVal == "-") ? fnameKey+".htm"  : fnameVal+".htm");
        } else {
          fnameVal = fnameKey+".htm";
        }
      } else {
        //not a valid platform choice
        //fnameVal = "x";
        fnameVal = fileName;
      }

      return fnameVal;
    },

    getCurrentLang : function() {
          var localedir = "en";
      if(window.docConfig !== undefined){
        localedir =   docConfig['localedir'].toLowerCase();
      }

      return localedir;
        },

    t : function(dataLang) {
      lg = this.getCurrentLang();

      var dict = (window.localeJsonObj || {});
      return dict[lg][dataLang] || dict['en'][dataLang] || dataLang;
        },

    setJsCookie: function (ckName, ckVal) {
  $.cookie (ckName, ckVal, {expires: 30, path:"/"});
    },



  }; //End of main return

}) ();



//Starting point
var switcherLocation = ".column-13 h1, .column-17 h1, .column-18 h1";
doc.switcher.addSwitcherLinks(switcherLocation);


$('#platforms .dropdown-menu a').on ("click", function (evt) {
  window.location.href = $(this).attr("href");
})

})
;
